<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireOps Tracker V3 (Cloud)</title>
    
    <meta name="theme-color" content="#b71c1c">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <style>
        :root {
            --fire-red: #b71c1c;
            --gold: #ffc107;
            --charcoal: #212121;
            --white: #ffffff;
            --light-gray: #f5f5f5;
        }

        body { font-family: sans-serif; background-color: var(--light-gray); margin: 0; padding-bottom: 50px; }

        header { background: var(--fire-red); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--gold); }
        header h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; }

        .container { max-width: 600px; margin: 15px auto; padding: 0 15px; }

        .card { background: var(--white); border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; font-size: 1.1rem; color: var(--charcoal); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }

        /* Inputs */
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 5px; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }

        /* Dashboard Stats */
        .stats-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .stat-box { flex: 1; background: var(--charcoal); color: var(--gold); padding: 15px; border-radius: 6px; text-align: center; }
        .stat-val { display: block; font-size: 1.5rem; font-weight: bold; }
        .stat-lbl { font-size: 0.75rem; text-transform: uppercase; color: white; opacity: 0.8; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-bottom: 8px; text-transform: uppercase; }
        .btn-add { background: var(--fire-red); color: white; }
        .btn-add:disabled { background: #e57373; cursor: not-allowed; } /* Loading state */
        .btn-undo { background: var(--gold); color: black; }
        .btn-csv { background: var(--charcoal); color: white; }
        .btn-reset { background: transparent; border: 2px solid var(--fire-red); color: var(--fire-red); margin-top: 10px; }

        /* Table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; background: #eee; padding: 8px; border-bottom: 2px solid #ddd; }
        td { padding: 8px; border-bottom: 1px solid #eee; }

        /* Status Bar */
        #statusMsg { text-align: center; font-size: 0.8rem; margin-bottom: 10px; min-height: 1.2em; font-weight: bold; }
        .status-syncing { color: var(--gold); }
        .status-success { color: green; }
        .status-error { color: red; }
    </style>
</head>
<body>

<header>
    <h1>FireOps Log V3</h1>
</header>

<div class="container">

    <div class="stats-row">
        <div class="stat-box">
            <span class="stat-val" id="dispAmount">$0.00</span>
            <span class="stat-lbl">Total</span>
        </div>
        <div class="stat-box">
            <span class="stat-val" id="dispCount">0</span>
            <span class="stat-lbl">Shifts</span>
        </div>
    </div>

    <div id="statusMsg"></div>

    <div class="card">
        <h2>New Entry</h2>
        <form id="entryForm">
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="inpName" placeholder="Name" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="inpDate" required>
            </div>
            <div class="form-group">
                <label>Shift</label>
                <input type="text" id="inpShift" placeholder="Shift" required>
            </div>
            <div class="form-group">
                <label>Amount ($)</label>
                <input type="number" id="inpAmount" step="0.01" placeholder="0.00" required>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-add">Add Entry</button>
        </form>
    </div>

    <div class="card">
        <h2>Actions</h2>
        <button type="button" id="btnUndo" class="btn btn-undo">Undo Last Local</button>
        <button type="button" id="btnCsv" class="btn btn-csv">Download CSV</button>
        <button type="button" id="btnReset" class="btn btn-reset">Master Reset</button>
    </div>

    <div class="card">
        <h2>History (Local)</h2>
        <div class="table-wrap">
            <table id="logTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Shift</th>
                        <th>$</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // ---------------------------------------------------------
    // FIXED: Your URL is now correctly inserted inside quotes
    // ---------------------------------------------------------
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzYuO3pbIAhk93DGmAY1ARLIyVYbkqnW1ir--zcNO5cwyPde3wp5q7y4iPF7f5cS0_a/exec"; 
    // ---------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('entryForm');
        const submitBtn = document.getElementById('submitBtn');
        const statusMsg = document.getElementById('statusMsg');
        
        const inpName = document.getElementById('inpName');
        const inpDate = document.getElementById('inpDate');
        const inpShift = document.getElementById('inpShift');
        const inpAmount = document.getElementById('inpAmount');
        
        const dispAmount = document.getElementById('dispAmount');
        const dispCount = document.getElementById('dispCount');
        const tableBody = document.querySelector('#logTable tbody');

        const btnUndo = document.getElementById('btnUndo');
        const btnCsv = document.getElementById('btnCsv');
        const btnReset = document.getElementById('btnReset');

        let entries = JSON.parse(localStorage.getItem('fireOpsData_v3')) || [];
        inpDate.value = new Date().toISOString().split('T')[0];
        render();

        function save() {
            localStorage.setItem('fireOpsData_v3', JSON.stringify(entries));
            render();
        }

        function render() {
            tableBody.innerHTML = '';
            let total = 0;
            entries.slice().reverse().forEach(item => {
                total += Number(item.amount);
                const row = `<tr>
                    <td>${item.date}</td>
                    <td>${item.name}</td>
                    <td>${item.shift}</td>
                    <td>$${Number(item.amount).toFixed(2)}</td>
                </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            dispAmount.textContent = '$' + total.toFixed(2);
            dispCount.textContent = entries.length;
        }

        // --- ADD ENTRY (Local + Cloud) ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // FIXED: Logic check now correctly handles the variable
            if (GOOGLE_SCRIPT_URL === "PASTE_YOUR_WEB_APP_URL_HERE" || GOOGLE_SCRIPT_URL === "") {
                alert("⚠️ Error: The Google Script URL is missing!");
                return;
            }

            // 1. UI Loading State
            submitBtn.disabled = true;
            submitBtn.textContent = "Syncing...";
            statusMsg.textContent = "Uploading to Cloud Database...";
            statusMsg.className = "status-syncing";

            const newEntry = {
                id: Date.now(),
                name: inpName.value,
                date: inpDate.value,
                shift: inpShift.value,
                amount: inpAmount.value
            };

            // 2. Send to Google Sheets (Corrected for no-cors)
            // Using URLSearchParams ensures data is sent as form fields, not JSON body
            const formData = new URLSearchParams();
            formData.append("date", newEntry.date);
            formData.append("name", newEntry.name);
            formData.append("shift", newEntry.shift);
            formData.append("amount", newEntry.amount);

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData.toString()
            })
            .then(() => {
                // 3. Success: Save Locally
                entries.push(newEntry);
                save();
                
                // 4. Reset UI
                form.reset();
                inpDate.value = new Date().toISOString().split('T')[0];
                statusMsg.textContent = "✔ Saved to Sheet & Local Storage";
                statusMsg.className = "status-success";
            })
            .catch(error => {
                console.error('Error:', error);
                statusMsg.textContent = "⚠ Network Error. Saved Locally Only.";
                statusMsg.className = "status-error";
                // Still save locally even if internet fails
                entries.push(newEntry);
                save();
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = "ADD ENTRY";
                setTimeout(() => { statusMsg.textContent = ""; }, 4000);
            });
        });

        // --- UNDO (Local Only) ---
        btnUndo.addEventListener('click', () => {
            if(entries.length === 0) return alert("Nothing to undo.");
            if(confirm("Undo last entry? (Note: This only removes it from this device, not the Google Sheet)")) {
                entries.pop();
                save();
            }
        });

        // --- CSV ---
        btnCsv.addEventListener('click', () => {
            if(entries.length === 0) return alert("No data to export.");
            let csv = "Date,Name,Shift,Amount\n";
            entries.forEach(row => {
                csv += `${row.date},${row.name.replace(/,/g, " ")},${row.shift.replace(/,/g, " ")},${row.amount}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'fire_log.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // --- RESET ---
        btnReset.addEventListener('click', () => {
            if(confirm("⚠️ DELETE ALL LOCAL DATA?")) {
                entries = [];
                save();
            }
        });
    });
</script>

</body>
</html>