<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Station Super Fund (Cloud)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* Mobile safe area padding */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .pt-safe-top { padding-top: env(safe-area-inset-top, 0px); }
        
        /* UI Tweaks */
        .select-none { user-select: none; -webkit-user-select: none; }
        .active-scale:active { transform: scale(0.95); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #b91c1c; /* Red-700 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 select-none h-screen flex flex-col overflow-hidden">

    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center transition-opacity duration-300">
        <div class="loader mb-4"></div>
        <p class="text-slate-500 font-medium animate-pulse">Syncing with Station Database...</p>
    </div>

    <div id="app" class="flex-1 flex flex-col h-full overflow-hidden opacity-0 transition-opacity duration-500">
        
        <header class="bg-red-700 text-white shadow-lg z-40 shrink-0 pt-safe-top">
            <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <i data-lucide="cloud" class="h-6 w-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight">Station Fund</h1>
                        <p class="text-xs text-red-100 font-medium opacity-80">CLOUD SYNC ACTIVE</p>
                    </div>
                </div>
                <div class="flex items-center bg-red-800/50 rounded-lg px-2 py-1 border border-red-600">
                    <button id="prevMonth" class="p-1 hover:bg-red-600 rounded active-scale">
                        <i data-lucide="chevron-left" class="h-5 w-5"></i>
                    </button>
                    <span id="currentMonthDisplay" class="mx-3 font-semibold min-w-[100px] text-center text-sm">Loading...</span>
                    <button id="nextMonth" class="p-1 hover:bg-red-600 rounded active-scale">
                        <i data-lucide="chevron-right" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden max-w-5xl mx-auto w-full relative">
            
            <aside class="hidden md:flex w-64 flex-col border-r border-slate-200 bg-white h-full shrink-0">
                <nav class="flex-1 p-4 space-y-2">
                    <button onclick="window.appState.setTab('dashboard')" class="nav-btn-desktop w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all text-slate-600 hover:bg-slate-50" data-tab="dashboard">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i> Dashboard
                    </button>
                    <button onclick="window.appState.setTab('payments')" class="nav-btn-desktop w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all text-slate-600 hover:bg-slate-50" data-tab="payments">
                        <i data-lucide="dollar-sign" class="w-5 h-5"></i> Log Payments
                    </button>
                    <button onclick="window.appState.setTab('analytics')" class="nav-btn-desktop w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all text-slate-600 hover:bg-slate-50" data-tab="analytics">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Reports
                    </button>
                    <button onclick="window.appState.setTab('roster')" class="nav-btn-desktop w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all text-slate-600 hover:bg-slate-50" data-tab="roster">
                        <i data-lucide="users" class="w-5 h-5"></i> Manage Roster
                    </button>
                </nav>
            </aside>

            <main id="mainContent" class="flex-1 overflow-y-auto p-4 pb-24 md:pb-4 select-text no-scrollbar">
                </main>
        </div>

        <nav class="md:hidden bg-white border-t border-slate-200 pb-safe fixed bottom-0 w-full z-40 flex justify-around items-center px-2 py-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="window.appState.setTab('dashboard')" class="nav-btn-mobile flex flex-col items-center justify-center w-full p-2 rounded-lg text-slate-400" data-tab="dashboard">
                <div class="p-1 rounded-lg mb-1"><i data-lucide="bar-chart-3" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-wide">Dash</span>
            </button>
            <button onclick="window.appState.setTab('payments')" class="nav-btn-mobile flex flex-col items-center justify-center w-full p-2 rounded-lg text-slate-400" data-tab="payments">
                <div class="p-1 rounded-lg mb-1"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-wide">Pay</span>
            </button>
            <button onclick="window.appState.setTab('analytics')" class="nav-btn-mobile flex flex-col items-center justify-center w-full p-2 rounded-lg text-slate-400" data-tab="analytics">
                <div class="p-1 rounded-lg mb-1"><i data-lucide="file-text" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-wide">Report</span>
            </button>
            <button onclick="window.appState.setTab('roster')" class="nav-btn-mobile flex flex-col items-center justify-center w-full p-2 rounded-lg text-slate-400" data-tab="roster">
                <div class="p-1 rounded-lg mb-1"><i data-lucide="users" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold uppercase tracking-wide">Roster</span>
            </button>
        </nav>
    </div>

    <script>
        // --- State Management ---
        const state = {
            activeTab: 'dashboard',
            currentDate: new Date(),
            roster: [],
            payments: [],
            monthlyDues: 20,
            isLoading: true
        };

        // --- Helpers ---
        const helpers = {
            // Returns "YYYY-MM" for filtering
            getMonthStr: () => state.currentDate.toISOString().slice(0, 7),
            
            // Returns payments only for current month
            getCurrentPayments: () => {
                const ms = helpers.getMonthStr();
                return state.payments.filter(p => p.monthStr === ms);
            },
            
            // Formatting
            formatMonth: (date) => date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
            
            // Math
            getStats: () => {
                const currentPayments = helpers.getCurrentPayments();
                const totalCollected = currentPayments.reduce((sum, p) => sum + p.amount, 0);
                const totalPotential = state.roster.length * state.monthlyDues;
                const percent = totalPotential > 0 ? Math.round((totalCollected / totalPotential) * 100) : 0;
                return { totalCollected, totalPotential, percent };
            }
        };

        // --- Google Connection & Loader ---
        
        function setLoading(bool) {
            state.isLoading = bool;
            const overlay = document.getElementById('loadingOverlay');
            const app = document.getElementById('app');
            
            if(bool) {
                overlay.style.opacity = '1';
                overlay.style.pointerEvents = 'all';
                overlay.style.display = 'flex'; // Ensure it's visible
            } else {
                overlay.style.opacity = '0';
                overlay.style.pointerEvents = 'none';
                app.style.opacity = '1';
                // Wait for fade out to hide display, but not strictly necessary with pointer-events:none
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }
        }

        // --- Core App Lifecycle ---

        function initApp() {
            console.log("App Initializing...");
            setLoading(true);
            
            // Call Backend
            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onDataError)
                .getAppData();
        }

        function onDataLoaded(serverData) {
            console.log("Data Received:", serverData);
            
            // Safely assign data
            state.roster = serverData.roster || [];
            state.payments = serverData.payments || [];
            state.monthlyDues = Number(serverData.monthlyDues) || 20;
            
            // Refresh UI
            setLoading(false);
            renderApp();
        }

        function onDataError(err) {
            console.error(err);
            alert("Connection Error:\n" + err.message);
            setLoading(false);
        }

        // --- Rendering Logic ---

        function renderApp() {
            // Update Month Header
            document.getElementById('currentMonthDisplay').textContent = helpers.formatMonth(state.currentDate);

            // Update Navigation Highlighting
            updateNavStyles();

            // Render Content based on Tab
            const main = document.getElementById('mainContent');
            
            switch(state.activeTab) {
                case 'dashboard':
                    main.innerHTML = renderDashboard();
                    break;
                case 'payments':
                    main.innerHTML = renderPayments();
                    break;
                case 'roster':
                    main.innerHTML = renderRoster();
                    break;
                case 'analytics':
                    main.innerHTML = renderAnalytics();
                    break;
            }
            
            // Initialize Icons (Lucide)
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function updateNavStyles() {
            // Desktop
            document.querySelectorAll('.nav-btn-desktop').forEach(btn => {
                const isActive = btn.dataset.tab === state.activeTab;
                btn.className = `nav-btn-desktop w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium transition-all ${isActive ? 'bg-red-50 text-red-700 shadow-sm border border-red-100' : 'text-slate-600 hover:bg-slate-50'}`;
                const icon = btn.querySelector('i, svg');
                if (icon) {
                    if(isActive) icon.classList.add('text-red-600');
                    else icon.classList.remove('text-red-600');
                }
            });

            // Mobile
            document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
                const isActive = btn.dataset.tab === state.activeTab;
                btn.className = `nav-btn-mobile flex flex-col items-center justify-center w-full p-2 rounded-lg transition-all active-scale ${isActive ? 'text-red-600' : 'text-slate-400'}`;
                const bg = btn.querySelector('div');
                if (bg) {
                    bg.className = `p-1 rounded-lg mb-1 ${isActive ? 'bg-red-50' : ''}`;
                }
            });
        }

        // --- Templates ---

        function renderDashboard() {
            const { totalCollected, totalPotential, percent } = helpers.getStats();
            const payments = helpers.getCurrentPayments();
            const recent = [...payments].sort((a,b) => b.timestamp.seconds - a.timestamp.seconds).slice(0, 5);

            return `
                <div class="space-y-6 animate-in fade-in duration-300">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Collected</p>
                            <p class="text-3xl font-bold text-slate-800 mt-1">$${totalCollected}</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <p class="text-slate-500 text-sm font-medium uppercase tracking-wider">Target</p>
                            <p class="text-3xl font-bold text-slate-400 mt-1">$${totalPotential}</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-end mb-2">
                            <h2 class="text-lg font-bold text-slate-800">Contribution Progress</h2>
                            <span class="font-bold text-xl ${percent >= 100 ? 'text-green-600' : 'text-red-600'}">${percent}%</span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-4 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000 ${percent >= 100 ? 'bg-green-500' : 'bg-red-600'}" style="width: ${Math.min(percent, 100)}%"></div>
                        </div>
                        <p class="text-sm text-slate-500 mt-2">${payments.length} out of ${state.roster.length} members have paid.</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100">
                            <h2 class="text-lg font-bold text-slate-800">Recent Payments</h2>
                        </div>
                        <div class="divide-y divide-slate-50">
                            ${recent.length === 0 ? '<div class="p-8 text-center text-slate-400 italic">No payments recorded this month.</div>' : ''}
                            ${recent.map(p => `
                                <div class="px-6 py-3 flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${getShiftColor(p.shift)}">${p.shift}</div>
                                        <div>
                                            <p class="font-semibold text-slate-800">${p.employeeName}</p>
                                            <p class="text-xs text-slate-400">Paid just now</p>
                                        </div>
                                    </div>
                                    <span class="font-bold text-green-600">+$${p.amount}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPayments() {
            const currentPayments = helpers.getCurrentPayments();
            // Group Roster by Shift
            const grouped = { A: [], B: [], C: [] };
            state.roster.forEach(e => { if(grouped[e.shift]) grouped[e.shift].push(e); });

            let html = `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-600 mb-6 animate-in fade-in duration-300">
                    <h2 class="text-xl font-bold text-slate-800">Log Payments</h2>
                    <p class="text-slate-500 text-sm">Tap a crew member to toggle payment (Dues: $${state.monthlyDues}).</p>
                </div>
            `;

            ['A', 'B', 'C'].forEach(shift => {
                const shiftMembers = grouped[shift];
                const shiftPaidCount = shiftMembers.filter(m => currentPayments.find(p => p.employeeId === m.id)).length;

                html += `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4 animate-in slide-in-from-bottom-2 duration-300">
                        <div class="bg-slate-50 px-6 py-3 border-b border-slate-200 font-bold text-slate-700 flex justify-between">
                            <span>Shift ${shift}</span>
                            <span class="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600 font-normal uppercase">${shiftPaidCount} / ${shiftMembers.length} Paid</span>
                        </div>
                        <div class="divide-y divide-slate-100">
                            ${shiftMembers.length === 0 ? '<div class="p-4 text-center text-slate-400 text-sm">No members in this shift.</div>' : ''}
                            ${shiftMembers.map(emp => {
                                const payment = currentPayments.find(p => p.employeeId === emp.id);
                                const isPaid = !!payment;
                                // Note: We pass payment ID if it exists so we can delete it
                                return `
                                    <button onclick="window.appActions.togglePayment('${emp.id}', '${emp.name}', '${emp.shift}', '${payment ? payment.id : ''}')" 
                                        class="w-full text-left px-6 py-4 flex items-center justify-between transition-all active:bg-slate-100 ${isPaid ? 'bg-green-50/50' : 'bg-white'}">
                                        <span class="font-semibold text-lg ${isPaid ? 'text-slate-800' : 'text-slate-500'}">${emp.name}</span>
                                        <div class="flex items-center gap-2 px-4 py-2 rounded-full border transition-all ${isPaid ? 'bg-green-100 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-400 shadow-sm'}">
                                            ${isPaid 
                                                ? `<i data-lucide="check-circle-2" class="w-5 h-5"></i><span class="font-bold text-sm">PAID</span>`
                                                : `<div class="w-5 h-5 rounded-full border-2 border-slate-300"></div><span class="font-medium text-sm">UNPAID</span>`
                                            }
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function renderRoster() {
            return `
                <div class="space-y-6 animate-in fade-in duration-300">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="bg-slate-100 p-2 rounded-lg text-slate-600"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                            <div>
                                <h2 class="text-xl font-bold text-slate-800">Fund Settings</h2>
                                <p class="text-xs text-slate-500">Monthly amount per person.</p>
                            </div>
                        </div>
                        <div class="flex items-end gap-4 max-w-md">
                            <div class="flex-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Monthly Dues ($)</label>
                                <input type="number" id="duesInput" value="${state.monthlyDues}" class="w-full p-3 border border-slate-300 rounded-lg font-bold text-slate-800">
                            </div>
                            <button onclick="window.appActions.updateDues()" class="bg-slate-800 text-